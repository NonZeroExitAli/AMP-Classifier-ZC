<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPIC-AMP Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
         :root {
            --primary-color: #004d40; /* Dark Teal */
            --secondary-color: #00897b; /* Teal */
            --success-color: #4caf50; /* Green */
            --warning-color: #ff9800; /* Orange */
            --info-color: #2196f3; /* Blue */
            --background-color: #f0f4c3; /* Light Lime */
            --text-color: #333; /* Dark Gray */
            --container-bg-color: #ffffff; /* White */
            --border-color: #bdbdbd; /* Light Gray */
            --button-hover-bg: #00695c; /* Darker Teal */
            --clear-button-bg: #f44336; /* Red */
            --clear-button-hover-bg: #d32f2f; /* Darker Red */
            --analyze-button-bg: #00897b; /* Teal */
            --analyze-button-hover-bg: #00695c; /* Darker Teal */
        }

/* Optional Dark Mode */
    .dark-mode {
        --primary-color: #b2dfdb;    /* Light Teal */
        --secondary-color: #4db6ac;  /* Medium Teal */
        --success-color: #81c784;    /* Light Green */
        --warning-color: #ffcc80;   /* Light Orange */
        --info-color: #90caf9;     /* Light Blue */
        --background-color: #212121; /* Dark Gray */
        --text-color: #eee;         /* Light Gray */
        --container-bg-color: #424242;/* Darker Gray */
        --border-color: #616161;    /* Medium Gray */
        --button-hover-bg: #004d40;  /* Dark Teal */
        --clear-button-bg: #e57373;  /* Light Red */
        --clear-button-hover-bg: #f44336; /* Red */
        --analyze-button-bg: #4db6ac;  /* Medium Teal */
        --analyze-button-hover-bg: #009688; /* Teal */
    }

    body {
        font-family: 'Arial', sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: var(--background-color);
        color: var(--text-color);
        transition: background-color 0.3s ease, color 0.3s ease;
    }

    .container {
        max-width: 800px;
        width: 100%;
        padding: 2rem;
        background: var(--container-bg-color);
        border-radius: 10px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        text-align: center;
        transition: background-color 0.3s ease;
        display: flex;
        flex-direction: column;
    }

    .input-group {
        margin-bottom: 1.5rem;
        position: relative;
    }

    #sequence {
        width: 100%;
        height: 150px;
        padding: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        font-family: monospace;
        font-size: 1rem;
        resize: vertical;
        transition: border-color 0.3s ease, background-color 0.3s ease;
        background-color: var(--container-bg-color);
        color: var(--text-color);
    }

    #file-input {
        margin-bottom: 1rem;
    }

    #sequence:focus {
        outline: none;
        border-color: var(--secondary-color);
    }

    button {
        color: white;
        border: none;
        padding: 0.8rem 2rem;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1rem;
        transition: transform 0.2s ease, background-color 0.3s ease;
        margin-top: 1rem;
    }
      .button-group button{
       margin: 0 0.2rem;
    }

    button:hover {
        transform: translateY(-1px);
    }

    #clear-btn {
        background-color: var(--clear-button-bg);
    }

    #clear-btn:hover {
        background-color: var(--clear-button-hover-bg);
    }

    #predict-btn {
        background-color: var(--analyze-button-bg);
    }

    #predict-btn:hover {
        background-color: var(--analyze-button-hover-bg);
    }


    .character-count {
        text-align: right;
        color: var(--text-color); /* Use text color */
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }


    .error-message {
         color: var(--warning-color);  /* Use warning color for errors */
        text-align: center;
        margin-top: 1rem;
        display: none;
    }


    .result {
        margin-top: 1.5rem;
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--primary-color);
        text-align: center;
    }

    .info-icon {
        position: absolute;
        top: 1rem;
        right: 1rem;
        font-size: 1.2rem;
        color: var(--info-color);
        cursor: pointer;
    }

    .tooltip {
        position: absolute;
        top: 100%;
        right: 0;
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 0.5rem;
        border-radius: 5px;
        display: none;
        z-index: 10;
        width: 250px;
        text-align: left;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .info-icon:hover + .tooltip,
    .tooltip:hover {
        display: block;
    }

    .progress-container {
         width: 100%;
        height: 8px;
        background-color: var(--border-color); /* Use border color */
        border-radius: 4px;
        margin-top: 1rem;
        overflow: hidden;
        display: none;
    }


    .progress-bar {
        height: 100%;
        width: 0;
        background-color: var(--success-color);
        transition: width: 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .result.show {
        animation: fadeIn 0.5s ease forwards;
    }

    .confidence-container { /* This block is likely unused now */
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: 0.5rem;
    }


    .hidden {
        display: none;
    }


   .tabs {
        display: flex;
        justify-content: center;
        margin-bottom: 1rem;
        border-bottom: 2px solid var(--border-color);
    }

    .tab {
        padding: 0.5rem 1rem;
        margin: 0 0.5rem;
        cursor: pointer;
        border: 2px solid transparent;
        border-radius: 5px 5px 0 0;
        background-color: transparent;
        color: var(--text-color);
        transition: border-color 0.3s ease, background-color 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

   .tab.active {
        border-color: var(--primary-color); /* Use primary color */
        background-color: var(--primary-color); /* Use primary color */
        color: white;
    }

    .tab-content {
        display: none;
        padding: 1rem;
        text-align: left;
    }

    .tab-content.active {
        display: block;
    }

    .metrics-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
         box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); /* Add a subtle shadow */
    }


    .metrics-table th, .metrics-table td {
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        text-align: center;
    }

   .metrics-table th {
        background-color: var(--primary-color); /* Consistent header color */
        color: white;
        font-weight: bold;
        text-transform: uppercase; /* Make headers uppercase */
        letter-spacing: 0.05em; /* Add some letter spacing */
    }

    .metrics-table td {
        padding: 0.8rem 0.5rem; /* Slightly more vertical padding */
    }

    .metrics-table tr:nth-child(even) {
        background-color: #f9f9f9; /* Alternate row background */
    }
    .dark-mode .metrics-table tr:nth-child(even) {
        background-color: #555; /* Dark mode alternate row color */
    }

    .logos-container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin-bottom: 1rem;
        width: 100%;
    }
    .logos-container img {

        transform: scale(1.083); /* Adjust the scale as needed */
        max-width: 100%;  /* Ensure the logo doesn't exceed its container */
        height: auto;     /* Maintain aspect ratio */
    }

    footer {
        text-align: center;
        padding: 20px;
        background-color: var(--container-bg-color);
        border-top: 1px solid var(--border-color);
        font-size: 0.9rem;
        color: var(--text-color);
        margin-top: auto;
        width: 100%;
    }
    footer p{
         margin: 0.5rem 0;
    }

    .button-group {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
    }

    #download-link {
      color: var(--secondary-color);
      text-decoration: none; /* Remove underline */
      font-weight: bold;
    }
    #download-link:hover{
        text-decoration: underline;
    }
    .tab-content h2 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
      border-bottom: 2px solid var(--secondary-color);
      padding-bottom: 0.25rem;
      display: inline-block; /* Keep the border tight to the text */
    }

    .tab-content h3 {
      color: var(--secondary-color);
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .tab-content ul {
        list-style: disc;  /* Use disc bullets */
        margin-left: 20px; /* Indent the list */
        padding-left: 0;   /* Remove default padding */
    }

    .tab-content li {
        margin-bottom: 0.25rem; /* Spacing between list items */
    }
    .tab-content p {
      margin-bottom: 1rem; /* Add some space below paragraphs */
      line-height: 1.7;  /* Increase line height for readability */
    }

    /* Style for SHAP Plot Container (adjust as needed) */
    #shap-plot-container {
        width: 100%;
        min-height: 300px; /* Adjust height as needed */
        border: 1px solid var(--border-color);
        border-radius: 5px;
        margin-top: 1rem;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow-x: auto; /* Enable horizontal scrolling if plot is wide */
    }
     #shap-plot-container img{
        max-width: 100%; /* Make sure image doesn't exceed container width */
        height: auto;    /* Maintain aspect ratio */
        display: block;   /* Prevent extra space below image */
    }

    /* New styles for result boxes and MIC checkboxes */
    .results-display-group {
        display: grid;
        grid-template-columns: 1fr 1fr; /* Two columns for AMP and Additional Details */
        gap: 1rem;
        margin-top: 2rem;
    }

    .result-box {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--container-bg-color);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        overflow: hidden;
        color: var(--text-color);
    }

    .dark-mode .result-box {
        background-color: #424242; /* Darker Gray */
        border-color: #616161;
    }


    .result-header {
        background-color: var(--primary-color);
        color: white;
        padding: 0.7rem 1rem;
        font-weight: bold;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .result-content {
        padding: 1rem;
        min-height: 50px; /* Ensure consistent height */
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    /* Styles for MIC Checkboxes */
    .mic-checkbox-group {
        margin-top: 1.5rem;
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background-color: var(--container-bg-color);
        box-shadow: 0 1px 5px rgba(0,0,0,0.05);
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-bottom: 1.5rem;
    }

    .dark-mode .mic-checkbox-group {
        background-color: #424242;
        border-color: #616161;
    }

    .mic-checkbox-container {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-size: 1rem;
        color: var(--text-color);
        user-select: none; /* Prevent text selection */
    }

    .mic-checkbox-container input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border: 2px solid var(--primary-color);
        border-radius: 4px;
        margin-right: 8px;
        cursor: pointer;
        position: relative;
        outline: none;
        transition: all 0.2s ease-in-out;
    }

    .mic-checkbox-container input[type="checkbox"]:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .mic-checkbox-container input[type="checkbox"]:checked::before {
        content: '\2713'; /* Checkmark unicode */
        display: block;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 14px;
        color: white;
    }

    .mic-checkbox-container .mic-label {
        margin-left: 5px;
        font-weight: normal;
    }

</style>

</head>
<body>

<div class="container">
    <div class="logos-container">
        <img src="image.png" alt="Tool Logo">
    </div>

    <div class="tabs">
        <div class="tab active" data-tab="prediction">
            <i class="fas fa-search"></i> Prediction
        </div>
        <div class="tab" data-tab="model">
            <i class="fas fa-chart-line"></i> Model Metrics & Interpretability
        </div>
        <div class="tab" data-tab="about">
            <i class="fas fa-info-circle"></i> About
        </div>
         <div class="tab" data-tab="usage">
            <i class="fas fa-book"></i> Usage Guide
        </div>
    </div>

    <div class="tab-content active" id="prediction">
       <h2>AMP & MIC Predictor</h2>
        <p>Enter an amino acid sequence (between 10 and 100 valid amino acids) or upload a FASTA file to predict AMP class and MIC values.</p>
        <div class="input-group">
            <input type="file" id="file-input" accept=".fasta,.fa,.fna">
            <textarea id="sequence" placeholder="Enter amino acid sequence (10-100 Valid AAs) or upload a FASTA file..." maxlength="100"></textarea>
            <div class="character-count">
                <span id="char-count">0</span>/100
            </div>
            <i class="info-icon" id="info-icon">ⓘ</i>
            <div class="tooltip">
                Enter the amino acid sequence you want to classify or upload a FASTA file. The sequence must be between 10 and 100 characters long and contain only standard amino acid characters (ACDEFGHIKLMNPQRSTVWY).
            </div>
        </div>

        <!-- MOVED: MIC prediction selection now here, above the buttons -->
        <h3 style="margin-top: 0rem; margin-bottom: 0.5rem;">Select Bacteria for MIC Prediction</h3>
        <p style="margin-top: 0; margin-bottom: 1rem;">Choose one or more bacteria for which you'd like to predict the Minimum Inhibitory Concentration (MIC) of the peptide. MIC prediction is only performed if the sequence is classified as an Antimicrobial Peptide (AMP).</p>

        <div class="mic-checkbox-group">
            <label class="mic-checkbox-container">
                <input type="checkbox" id="mic-ecoli" value="e_coli" disabled>
                <span class="mic-label">E.coli</span>
            </label>
            <label class="mic-checkbox-container">
                <input type="checkbox" id="mic-paeruginosa" value="p_aeruginosa" disabled>
                <span class="mic-label">P. aeruginosa</span>
            </label>
            <label class="mic-checkbox-container">
                <input type="checkbox" id="mic-saureus" value="s_aureus" disabled>
                <span class="mic-label">S. aureus</span>
            </label>
            <label class="mic-checkbox-container">
                <input type="checkbox" id="mic-kpneumoniae" value="k_pneumoniae" disabled>
                <span class="mic-label">K. pneumoniae</span>
            </label>
        </div>
        <!-- END MOVED SECTION -->

        <div class="button-group">
            <button onclick="clearInput()" id="clear-btn">Clear Input</button>
            <button onclick="classifySequenceDebounced()" id="predict-btn">Submit</button>
        </div>


        <div class="error-message" id="error"></div>


        <div class="progress-container" id="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
        </div>

        <!-- UPDATED RESULT DISPLAY STRUCTURE -->
        <div class="results-display-group">
            <div class="result-box">
                <div class="result-header"><i class="fas fa-file-alt"></i> AMP Classification</div>
                <div class="result-content" id="amp-classification-output">
                    <p style="text-align: center;">▓▓▓</p>
                </div>
            </div>

            <!-- New box for additional details message -->
            <div class="result-box">
                <div class="result-header"><i class="fas fa-info-circle"></i> Additional Details</div>
                <div class="result-content" id="additional-details-output">
                    <p style="text-align: center;">Results will appear here.</p>
                </div>
            </div>
        </div>

        <a id="download-link" style="display: none; margin-top: 10px;">Download Detailed Report</a>
    </div>

    <div class="tab-content" id="model">
        <h2>Model Metrics</h2>
        <p>The following table presents the performance metrics of our antimicrobial peptide classification model. These metrics were obtained on a held-out test set, separate from the training data.</p>
        <table class="metrics-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Accuracy</td>
                    <td>0.963</td>
                    <td>The overall correctness of the model, representing the proportion of correctly classified sequences (both AMP and Non-AMP).</td>
                </tr>
                <tr>
                    <td>Precision</td>
                    <td>0.964</td>
                    <td>Out of all sequences predicted as AMPs, the proportion that are truly AMPs.  A high precision indicates fewer false positives.</td>
                </tr>
                <tr>
                    <td>Recall</td>
                    <td>0.963</td>
                    <td>Out of all actual AMP sequences, the proportion that the model correctly identifies. A high recall indicates fewer false negatives.</td>
                </tr>
                <tr>
                    <td>F1-Score</td>
                    <td>0.963</td>
                    <td>The harmonic mean of precision and recall, providing a balanced measure of the model's performance.</td>
                </tr>
                <tr>
                    <td>Validation Accuracy</td>
                    <td>0.968</td>
                    <td>The accuracy of the model on a separate validation dataset, used during model development to tune hyperparameters.</td>
                </tr>
            </tbody>
        </table>

        <h2 style="margin-top: 2rem;">Model Interpretability</h2>
        <p>To understand how our model makes predictions, we use SHAP (SHapley Additive exPlanations) values. SHAP values help to explain the output of the model by assessing the contribution of each feature to the prediction.</p>

        <h3>SHAP Plot</h3>
        <p>The SHAP plot below visualizes the features that most significantly influence the model's prediction. Positive SHAP values contribute to the sequence being classified as AMP, while negative values contribute to Non-AMP classification.</p>

        <div id="shap-plot-container">
            <img src="shap.png" alt="SHAP Plot" >
        </div>

        

        <h3>Sample Run</h3>
         <p>You can test the model with various sequences to understand its behavior.  Here are a few examples:</p>
        <ul>
            <li><strong>Test 1:</strong> Long Sequence of 99 AAs (P-AMP) - MEKAALIFIGLLLFSTCTQILAQSCNNDSDCTNLKCATKNIKCEQNKCQCLDERYIRAISLNTRSPRCNVQSCIDHCKAIGEVIYVCFTYHCYCRKPPM</li>
            <li><strong>Test 2:</strong> Long Sequence of 99 AAs (Non-AMP) - MKSLLPLAILAALAVAALCYESHESMESYEVSPFTTRRNANTFISPQQRWHAKAQERVRELNKPAQEINREACDDYKLCERYALIYGYNAAYNRYFRQR</li>
            <li><strong>Test 3:</strong> Short Sequence of 51 AAs (P-AMP) - SLQGGAPNFPQPSQQNGGWQVSPDLGRDDKGNTRGQIEIQNKGKDHDFNAG</li>
            <li><strong>Test 4:</strong> Short Sequence of 50 AAs (Non-AMP) - MKPLKQKVSITLDEDVIKNLKTLAEECDRSLSQYINLILKEHLKNLDQQ</li>
            <li><strong>Test 5:</strong> Invalid Characters (eg. X) - MEKAALIFIGLLLFSTCTQILAQSC(XX).</li>

        </ul>


    </div>

    <div class="tab-content" id="about">
        <h2>About This Tool</h2>
        <p>This web application provides a user-friendly interface for classifying amino acid sequences as either Antimicrobial Peptides (AMPs) or Non-Antimicrobial Peptides (Non-AMPs). AMPs are crucial components of the innate immune system, offering defense against a wide range of pathogens.</p>

        <h3>Model Selection Criteria</h3>
        <p>Our team rigorously evaluated 225 combinations of feature extraction and selection methods across three distinct machine learning models. The final model was selected based on the following criteria:</p>
        <ul>
            <li><strong>High Accuracy, F1-score, and Validation Accuracy:</strong> The model achieved excellent performance metrics on a held-out test set, demonstrating its ability to generalize to unseen data.</li>
            <li><strong>Robustness to Sequence Length Variations:</strong> The model performs consistently well on sequences of varying lengths, within the specified range (10-100 amino acids).</li>
            <li><strong>Generalization Ability:</strong> The model was trained and evaluated on diverse datasets to ensure its ability to classify a broad range of AMP sequences.</li>
        </ul>

        <h3>Intended Use</h3>
        <p>This tool is intended for research and educational purposes. It can be a valuable resource for researchers studying antimicrobial peptides and developing new therapeutic strategies. However, it is *not* a substitute for experimental validation.</p>

        <h3>Our Team</h3>
        <ul>
            <li>Ali Magdi - Computational Biologist</li>
            <li>Ahmed Amr - Computational Biologist</li>
            <li>Omar Loay - Molecular Biologist</li>
            <li>Prof. Eman Badr - Full Professor and Director of BCBU</li>
        </ul>

        <h3>Acknowledgements</h3>
        <p>We extend our gratitude to the following organizations for their support:</p>
        <ul>
            <li>Bioinformatics and Computational Biology Unit at Zewail City.</li>
            <li>The Centre for Genomics at Zewail City.</li>
        </ul>

        <h3>Contact</h3>
        <p>For questions, inquiries, or feedback, please reach out to us at: <a href="mailto:s-ali.afifi@zewailcity.edu.eg">s-ali.afifi@zewailcity.edu.eg</a></p>
    </div>
     <div class="tab-content" id="usage">
         <h2>Usage Guide</h2>
        <p>Follow these steps to use the AMP Classifier:</p>

        <h3>Step 1: Prepare Your Sequence</h3>
        <ul>
            <li>You can either enter the amino acid sequence directly or upload a FASTA file.</li>
            <li>Ensure your sequence contains only standard amino acid characters (ACDEFGHIKLMNPQRSTVWY).</li>
             <li>The sequence length must be between 10 and 100 amino acids.</li>
        </ul>

        <h3>Step 2: Input the Sequence</h3>
        <ul>
            <li><strong>Direct Input:</strong> Type or paste your sequence into the text area provided.</li>
            <li><strong>FASTA File Upload:</strong> Click the "Choose File" button and select your .fasta, .fa, or .fna file.</li>
            <li>The character count will update as you type or upload a sequence.</li>
        </ul>

        <h3>Step 3: Analyze the Sequence</h3>
        <ul>
            <li>Click the "Analyze Sequence" button.</li>
            <li>A progress bar will appear, indicating that the analysis is underway.</li>
        </ul>

        <h3>Step 4: View the Results</h3>
        <ul>
            <li>Once the analysis is complete, the prediction (AMP or Non-AMP) will be displayed.</li>
            <li>You can download a detailed report in PDF format by clicking the "Detailed Report" link.</li>
        </ul>

        <h3>Step 5: Clear the Input</h3>
        <ul>
             <li>To analyze another sequence, click the "Clear Input" button. This will reset the input fields and results.</li>
        </ul>
         <h3>Troubleshooting</h3>
            <ul>
                <li><strong>Invalid Characters:</strong> If you see an error message about invalid characters, double-check that your sequence contains only standard amino acid characters.</li>
                <li><strong>Sequence Length:</strong> Ensure your sequence is between 10 and 100 characters long.</li>
                 <li><strong>Invalid FASTA Format:</strong> If you encounter an error with a FASTA file, make sure the file is correctly formatted.</li>
            </ul>

    </div>
</div>
<footer>
    <p>© 2025, Bioinformatics and Computational biology Unit, BCBU</p>
    <address>
     Bioinformatics and Computational biology Unit at Zewail City,<br>
      Ahmed Zewail Street, October Gardens, Giza,<br>
      Egypt
    </address>
</footer>
<script type="module">
    import { client } from "https://cdn.jsdelivr.net/npm/@gradio/client/+esm";
    window.gradio = { client };
</script>

<script>
    const sequenceInput = document.getElementById('sequence');
    const charCount = document.getElementById('char-count');
    const errorDiv = document.getElementById('error');
    const predictBtn = document.getElementById('predict-btn');
    const progressContainer = document.getElementById('progress-container');
    const progressBar = document.getElementById('progress-bar');
    const fileInput = document.getElementById('file-input');
    const downloadLink = document.getElementById('download-link');
    const shapPlotContainer = document.getElementById('shap-plot-container');

    // References for the structured results display
    const ampClassificationOutput = document.getElementById('amp-classification-output');
    const additionalDetailsOutput = document.getElementById('additional-details-output');

    // References for MIC checkboxes
    const micCheckboxes = document.querySelectorAll('.mic-checkbox-group input[type="checkbox"]');

    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));
            tab.classList.add('active');
            document.getElementById(tab.dataset.tab).classList.add('active');
        });
    });

    let clientInstance;
    let debounceTimer; // For debouncing prediction calls
    let animationIntervalId; // To store the ID of the progress bar animation interval

    async function initClient() {
        try {
            // Ensure this URL points to your deployed Gradio app with the correct functions
            clientInstance = await window.gradio.client("nonzeroexit/AMP-Classifier");
        } catch (error) {
            console.error("Failed to initialize Gradio client:", error);
            showError("Failed to connect to the classifier service. Please check your network and try again.");
            predictBtn.disabled = true;
        }
    }

    window.onload = function() {
        initClient();
        document.getElementById('info-icon').addEventListener('mouseenter', showTooltip);
        document.getElementById('info-icon').addEventListener('mouseleave', hideTooltip);
        fileInput.addEventListener('change', handleFileSelect);
        // Initial clearing of output fields and disabling checkboxes
        clearInput();
    };

    function showTooltip() {
        document.querySelector('.tooltip').style.display = 'block';
    }

    function hideTooltip() {
        document.querySelector('.tooltip').style.display = 'none';
    }

    function clearInput() {
        sequenceInput.value = '';
        fileInput.value = '';
        charCount.textContent = '0';
        clearError();
        downloadLink.style.display = 'none';
        shapPlotContainer.innerHTML = '<p><i>SHAP plot will be displayed here after analysis.</i></p>';

        // Clear classification and additional details
        ampClassificationOutput.innerHTML = '<p style="text-align: center;">▓▓▓</p>';
        additionalDetailsOutput.innerHTML = '<p style="text-align: center;">Results will appear here.</p>';

        // Disable MIC checkboxes and uncheck them
        micCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
            checkbox.disabled = true;
        });

        // Clear any ongoing progress bar animation
        if (animationIntervalId) {
            clearInterval(animationIntervalId);
            animationIntervalId = null;
        }
        progressBar.style.width = '0%';
        progressContainer.style.display = 'none';
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) {
            clearInput(); // Clear everything if no file selected/cancelled
            return;
        }

        const allowedExtensions = ['.fasta', '.fa', '.fna'];
        const fileName = file.name.toLowerCase();
        const isValidExtension = allowedExtensions.some(ext => fileName.endsWith(ext));

        if (!isValidExtension) {
            showError('Invalid file type. Please upload a .fasta, .fa, or .fna file.');
            fileInput.value = ''; // Clear file input so same file can be selected again
            micCheckboxes.forEach(checkbox => checkbox.disabled = true);
            return;
        }

        clearError(); // Clear previous errors

        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                const sequence = parseFASTA(e.target.result);
                if (sequence) {
                    sequenceInput.value = sequence;
                    updateCharacterCount();
                    validateSequence(sequence); // This will enable/disable checkboxes based on the FASTA content
                } else {
                    showError("No valid sequence found in FASTA file.");
                    fileInput.value = '';
                    micCheckboxes.forEach(checkbox => checkbox.disabled = true);
                }
            } catch (error) {
                console.error("Error in reader.onload:", error);
                showError(error.message);
                fileInput.value = '';
                micCheckboxes.forEach(checkbox => checkbox.disabled = true);
            }
        };

        reader.onerror = function(error) {
            console.error("FileReader error:", error);
            showError("Error reading file.");
            fileInput.value = '';
            micCheckboxes.forEach(checkbox => checkbox.disabled = true);
        };

        reader.readAsText(file);
    }

    function parseFASTA(text) {
        const lines = text.trim().split(/[\r\n]+/);
        const sequences = [];
        let currentSequence = '';
        let hasHeader = false;

        for (const line of lines) {
            const trimmedLine = line.trim();
            if (trimmedLine.startsWith('>')) {
                if (hasHeader && currentSequence) {
                    sequences.push(currentSequence);
                }
                currentSequence = '';
                hasHeader = true;
            } else if (hasHeader && trimmedLine) {
                currentSequence += trimmedLine.replace(/\s/g, '').toUpperCase();
            }
        }

        if (hasHeader && currentSequence) {
            sequences.push(currentSequence);
        }

        if (sequences.length === 0) {
            throw new Error("Invalid FASTA format. No valid sequences found.");
        }
        if (sequences.length > 1) {
            console.warn("Multiple sequences found in FASTA file. Using only the first sequence.");
            return sequences[0];
        } else {
            return sequences[0];
        }
    }

    function validateSequence(sequence) {
        let isValid = true;
        let errorMessage = '';

        if (!sequence) {
            isValid = false;
        } else if (/[^ACDEFGHIKLMNPQRSTVWY]/.test(sequence)) {
            errorMessage = 'Invalid characters in sequence. Only standard amino acid characters (ACDEFGHIKLMNPQRSTVWY) are allowed.';
            isValid = false;
        } else if (sequence.length < 10 || sequence.length > 100) {
            errorMessage = 'Sequence length must be between 10 and 100 characters.';
            isValid = false;
        }

        if (isValid) {
            clearError();
            predictBtn.disabled = false; // Re-enable predict button if valid
        } else {
            showError(errorMessage); // Show specific error message
            predictBtn.disabled = true; // Disable predict button if invalid
        }

        // Enable/disable checkboxes based on validation result
        micCheckboxes.forEach(checkbox => {
            checkbox.disabled = !isValid;
            if (!isValid) checkbox.checked = false; // Uncheck if disabled
        });

        return isValid;
    }

    function updateCharacterCount() {
        charCount.textContent = sequenceInput.value.length;
    }

    sequenceInput.addEventListener('input', () => {
        updateCharacterCount();
        validateSequence(sequenceInput.value); // Re-validate on every input
    });

    sequenceInput.addEventListener('paste', (e) => {
        e.preventDefault();
        const paste = (e.clipboardData || window.clipboardData).getData('text');
        // Clean paste immediately, but full validation happens next
        const cleanPaste = paste.replace(/[^ACDEFGHIKLMNPQRSTVWY]/gi, '').toUpperCase();

        // Get current selection
        const selectionStart = sequenceInput.selectionStart;
        const selectionEnd = sequenceInput.selectionEnd;

        // Construct potential new text
        const currentText = sequenceInput.value;
        const newText = currentText.substring(0, selectionStart) + cleanPaste + currentText.substring(selectionEnd);

        // Apply new text and validate
        sequenceInput.value = newText;
        updateCharacterCount();

        // Validate the entire new sequence
        if (!validateSequence(newText)) {
            // If the pasted text (or the resulting length) makes the sequence invalid
            // The validateSequence function already calls showError and disables checkboxes/button
            // No need to revert the text, as the error message explains the issue.
        }
    });

    sequenceInput.addEventListener('keypress', (e) => {
        // Allow common control keys (backspace, delete, arrow keys, etc.)
        if (e.key.length === 1 && !/^[ACDEFGHIKLMNPQRSTVWY]$/i.test(e.key)) {
            e.preventDefault();
            // Show error immediately for invalid characters, but let validateSequence handle overall state
            showError('Only standard amino acid characters are allowed.');
        } else {
            // If a valid character is typed or a control key, clear error for the moment
            clearError();
        }
        // validateSequence will be called on 'input' event (after keypress)
    });

    function showError(message) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    function clearError() {
        errorDiv.style.display = 'none';
    }

    async function classifySequenceDebounced() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(classifySequence, 300);
    }

    async function classifySequence() {
        const sequence = sequenceInput.value.trim().toUpperCase();

        if (!validateSequence(sequence)) { // Re-validate one last time
            return;
        }

        clearError();
        predictBtn.disabled = true;
        predictBtn.textContent = 'Processing...';

        // Set initial processing states for UI
        ampClassificationOutput.innerHTML = '<p style="text-align: center;">Analyzing...</p>';
        additionalDetailsOutput.innerHTML = '<p style="text-align: center;">Generating detailed report...</p>';
        shapPlotContainer.innerHTML = '<p><i>Generating SHAP plot...</i></p>';
        downloadLink.style.display = 'none'; // Ensure it's hidden initially

        progressContainer.style.display = 'block';
        progressBar.style.width = '0%'; // Reset progress bar

        let micDataForPdf = {}; // To store MIC data for PDF report
        let ampLabel = 'Unknown';
        let ampConfidence = 0;
        let shapPlotBase64 = null;

        // --- Start progress bar animation (independent of actual processing) ---
        let animationProgress = 0;
        animationIntervalId = setInterval(() => {
            if (animationProgress < 95) { // Stop just before 100% to leave room for final "completion"
                animationProgress += 5; // Increment by 5%
                progressBar.style.width = `${animationProgress}%`;
            }
        }, 100); // Update every 100ms

        try {
            // --- Step 1: Perform AMP Classification (blocking await) ---
            const classificationResult = await clientInstance.predict("/predict", [sequence]);
            
            // Stop the progress bar animation once the *actual* classification is done
            clearInterval(animationIntervalId);
            animationIntervalId = null; // Clear the stored interval ID
            progressBar.style.width = '100%'; // Immediately set to 100%
            progressContainer.style.display = 'none'; // Hide it

            if (!classificationResult || !classificationResult.data || !classificationResult.data[0]) {
                throw new Error("Invalid classification result from server. Please check backend response.");
            }

            ampLabel = classificationResult.data[0].label;
            ampConfidence = typeof classificationResult.data[0].confidence === 'number' ? classificationResult.data[0].confidence : 0;
            shapPlotBase64 = classificationResult.data[0].shap_plot_base64;

            // Display AMP classification
            ampClassificationOutput.innerHTML = `<p style="font-size: 1.3rem; font-weight: bold; color: ${ampLabel.includes('Non-AMP') ? 'var(--clear-button-bg)' : 'var(--success-color)'}; margin: 0;">${ampLabel}</p>`;

            // Display SHAP Plot
            if (shapPlotBase64) {
                const shapPlotImg = document.createElement('img');
                shapPlotImg.src = `data:image/png;base64,${shapPlotBase64}`;
                shapPlotImg.alt = 'SHAP Plot';
                shapPlotContainer.innerHTML = '';
                shapPlotContainer.appendChild(shapPlotImg);
            } else {
                shapPlotContainer.innerHTML = '<p><i>SHAP plot not available for this prediction.</i></p>';
            }

            // --- Step 2: Perform MIC Prediction if AMP and checkboxes are selected (blocking await) ---
            if (ampLabel.includes('AMP (Positive)')) {
                const selectedBacteria = Array.from(micCheckboxes)
                                            .filter(checkbox => checkbox.checked)
                                            .map(checkbox => checkbox.value);

                if (selectedBacteria.length > 0) {
                    try {
                        const micPredictionResult = await clientInstance.predict("/predict_mic", [sequence, selectedBacteria]);

                        if (micPredictionResult && micPredictionResult.data && micPredictionResult.data[0]) {
                            micDataForPdf = micPredictionResult.data[0]; // Store for PDF
                            additionalDetailsOutput.innerHTML = '<p style="text-align: center;">Detailed report (including confidence and MIC values) is available for download.</p>';
                        } else {
                            additionalDetailsOutput.innerHTML = '<p style="text-align: center; color: var(--warning-color);">MIC data could not be retrieved for the report. Report may be incomplete.</p>';
                        }
                    } catch (micError) {
                        console.error("Error during MIC prediction:", micError);
                        additionalDetailsOutput.innerHTML = '<p style="text-align: center; color: var(--warning-color);">Error predicting MIC for report: ' + (micError.message || 'Unknown error') + '</p>';
                    }
                } else {
                    additionalDetailsOutput.innerHTML = '<p style="text-align: center;">Detailed report (including confidence) is available for download. No MIC values selected.</p>';
                }
            } else {
                // Not an AMP, so no MIC prediction even if checkboxes were selected
                additionalDetailsOutput.innerHTML = '<p style="text-align: center;">Detailed report (including confidence) is available for download. MIC prediction not applicable (Non-AMP).</p>';
            }

            // --- Final Step: Generate PDF Report and show download link ---
            generatePDFReport(sequence, ampLabel, ampConfidence, micDataForPdf);
            downloadLink.style.display = 'block'; // Always show download link if primary prediction is done

        } catch (error) {
            console.error("Error during prediction:", error);
            // Ensure animation stops on error too
            if (animationIntervalId) {
                clearInterval(animationIntervalId);
                animationIntervalId = null;
            }
            progressBar.style.width = '0%'; // Reset or clear on error
            progressContainer.style.display = 'none';

            showError("Prediction failed: " + (error.message || "Unknown error"));
            shapPlotContainer.innerHTML = '<p><i>Error generating SHAP plot.</i></p>';
            ampClassificationOutput.innerHTML = '<p style="text-align: center; color: var(--clear-button-bg);">Error</p>';
            additionalDetailsOutput.innerHTML = '<p style="text-align: center; color: var(--clear-button-bg);">Error during prediction. Detailed report not available.</p>';
            downloadLink.style.display = 'none'; // Hide download link on critical error
        } finally {
            predictBtn.disabled = false;
            predictBtn.textContent = 'Submit';
        }
    }

    function generatePDFReport(sequence, prediction, confidence, micResults = null) {
        if (!window.jspdf || !window.jspdf.jsPDF) {
            console.error("jsPDF is not loaded correctly.");
            return;
        }
        const jsPDF = window.jspdf.jsPDF;
        const pdf = new jsPDF();

        if (!sequence || !prediction) {
            console.error("Cannot generate PDF: Missing data.", { sequence, prediction });
            return;
        }

        pdf.setFontSize(22);
        pdf.setTextColor(44, 62, 80); // Dark Blue-Gray
        pdf.text("AMP Classification & MIC Report", 105, 20, { align: "center" });

        const imgData = getBase64Image(document.querySelector('.logos-container img'));
          if (imgData) {
            pdf.addImage(imgData, 'PNG', 25, 22, 30, 15);
        }

        let yPos = 55;

        // Input Sequence
        pdf.setFontSize(16);
        pdf.setTextColor(0, 77, 64); // Dark Teal (from --primary-color)
        pdf.text("Input Sequence:", 20, yPos);
        pdf.setFontSize(12);
        pdf.setTextColor(51, 51, 51); // Dark Gray (from --text-color)
        const maxWidth = 170;
        const sequenceLines = pdf.splitTextToSize(sequence, maxWidth);
        pdf.text(sequenceLines, 20, yPos + 10);
        yPos += 10 + (sequenceLines.length * pdf.getLineHeight()) + 10;

        // AMP Classification
        pdf.setFontSize(16);
        pdf.setTextColor(0, 77, 64); // Dark Teal
        pdf.text("AMP Classification:", 20, yPos);
        pdf.setFontSize(14);
        if (prediction.includes('(Non-AMP)')) {
             pdf.setTextColor(231, 76, 60); // Alizarin Red
         } else {
            pdf.setTextColor(39, 174, 96); // Emerald Green
         }
        pdf.text(prediction, 20, yPos + 10);
        yPos += 20;

        // Confidence
        pdf.setFontSize(16);
        pdf.setTextColor(0, 77, 64); // Dark Teal
        pdf.text("Confidence:", 20, yPos);
        pdf.setFontSize(14);
        pdf.setTextColor(39, 174, 96); // Emerald Green
        pdf.text(`${(confidence * 100).toFixed(2)}%`, 20, yPos + 10);
        yPos += 20;

        // MIC Predictions (if available)
        if (micResults && Object.keys(micResults).length > 0) {
            pdf.setFontSize(16);
            pdf.setTextColor(0, 77, 64); // Dark Teal
            pdf.text("Predicted MIC (µM):", 20, yPos);
            yPos += 10;
            pdf.setFontSize(12);
            pdf.setTextColor(51, 51, 51); // Dark Gray
            const bacteriumDisplayNamesForPdf = {
                'e_coli': 'E.coli',
                'p_aeruginosa': 'P. aeruginosa',
                's_aureus': 'S. aureus',
                'k_pneumoniae': 'K. pneumoniae',
                // Add any other bacteria keys your backend might return
            };

            for (const bacteriumKey in micResults) {
                if (typeof micResults[bacteriumKey] === 'number' && bacteriumDisplayNamesForPdf[bacteriumKey]) {
                    const bacteriumName = bacteriumDisplayNamesForPdf[bacteriumKey];
                    pdf.text(`${bacteriumName}: ${micResults[bacteriumKey].toFixed(2)} µM`, 20, yPos);
                    yPos += 7; // Line spacing
                }
            }
            yPos += 10; // Add extra space after MIC list
        } else {
            pdf.setFontSize(12);
            pdf.setTextColor(100, 100, 100);
            pdf.text("No MIC predictions were selected or generated for this peptide.", 20, yPos + 10);
            yPos += 20;
        }


        pdf.setFontSize(10);
        pdf.setTextColor(127, 140, 141); // Gray
        pdf.text("Generated by BCBU-ZC AMP Classifier", 105, 285, { align: "center" });

        const pdfBlob = pdf.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);

        downloadLink.href = pdfUrl;
        downloadLink.download = `AMP_Classifier_Report_${new Date().toISOString().slice(0, 10)}.pdf`;
    }

    function getBase64Image(img) {
        if (!img) {
            console.error("Image element not found");
            return null;
        }
        try{
            const canvas = document.createElement("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            const dataURL = canvas.toDataURL("image/png");
            return dataURL;
        }
        catch (error){
            console.error("Error converting image to base64:", error);
            return null
        }
    }

</script>

</body>
</html>
